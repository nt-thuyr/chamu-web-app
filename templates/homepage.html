{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}Home{% endblock %}

{% block homepage_auth_buttons %}
    {% if user.is_authenticated %}
        <li class="nav-item me-2">
            <button id="update-btn" class="btn custom-update-btn rounded-pill" data-bs-toggle="modal" data-bs-target="#updateModal">
                {% trans "Update" %}
            </button>
        </li>
        <li class="nav-item">
            <button id="logout-btn" class="btn custom-logout-btn rounded-pill">
                {% trans "Logout" %}
            </button>
        </li>
    {% else %}
        <li class="nav-item me-2">
            <button id="login-btn" class="btn custom-login-btn rounded-pill" data-bs-toggle="modal" data-bs-target="#loginModal">
                {% trans "Log in" %}
            </button>
        </li>
        <li class="nav-item">
            <button id="signup-btn" class="btn custom-signup-btn rounded-pill" data-bs-toggle="modal" data-bs-target="#signupModal">
                {% trans "Sign up" %}
            </button>
        </li>
    {% endif %}
{% endblock %}

{% block content %}
<script src="{% static 'chamu/home_trans.js' %}"></script>
<div class="bg_test">
      <img src="{% static 'chamu/sakura.jpg' %}" class="bg_test-img img1">
      <img src="{% static 'chamu/hanabi.jpg' %}" class="bg_test-img img2">
      <img src="{% static 'chamu/ityou.jpg' %}" class="bg_test-img img3">
      <img src="{% static 'chamu/yuki.jpg' %}" class="bg_test-img img4">
      <div class="bg_test-overlay"></div>
</div>
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <h2 class="mb-4 text-center">住みたい 日本ナビ</h2>
        <form id="main-info-form" method="post" novalidate>
            {% csrf_token %}
            {{ formset.management_form }}
            <input type="hidden" name="next_action" id="next_action_input" value="">
            {{ form.as_p }}
            <div class="d-flex justify-content-center gap-3">
                <button type="button" id="start-matching-btn" class="btn btn-outline-primary">次に住む地域探し</button>
                <button type="button" id="start-evaluation-btn" class="btn btn-outline-primary">住んでいる地域の評価</button>
            </div>
        </form>
    </div>
</div>
<!-- Modals only show on homepage -->
{% include "modals/login_modal.html" %}
{% include "modals/signup_modal.html" %}
{% include "modals/update_modal.html" %}
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const matchInfoUrl = "{% url 'match_info' %}";
        const evaluateInfoUrl = "{% url 'evaluate_info' %}";

        document.getElementById("start-matching-btn").onclick = function() {
            window.location.href = matchInfoUrl;
        };
        document.getElementById("start-evaluation-btn").onclick = function() {
            window.location.href = evaluateInfoUrl;
        };
    });

    $(function() {
        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        // Logout AJAX
        $('#logout-btn').on('click', function() {
            $.ajax({
                url: '{% url "ajax_logout" %}',
                method: 'POST',
                data: {},
                success: function(data) {
                    if (data.success) {
                        location.reload();
                    }
                }
            });
        });
    });
</script>
{% endblock %}