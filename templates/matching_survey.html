{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% block title %}{% trans "Matching Survey" %}{% endblock %}

{% block content %}
<style>
    nav {
        position: relative;
        z-index: 2; /* .bg-blur より高くする */
    }
    .bg-blur {
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: url("{% static 'chamu/tokai.jpg' %}") ;
        background-size: cover;
        filter: blur(1px);
        z-index: 0;
        opacity: 0.7;
    }
    .content-on-blur {
        position: relative;
        z-index: 1;
    }
</style>
<div class="bg-blur"></div>
<div class="content-on-blur">
    <div class="row justify-content-center ">
        <div class="col-md-12 col-lg-10">
            <!-- Card container -->
            <div class="card shadow-lg  rounded-4 p-4" style="background-color: #ffffff; border: 2px solid #77b6e0ff; border-radius: 10px; padding: 20px;">
                <div class="text-center mb-4">
                    <h2 class="fw-bold" style="color: #2c3e50;">
                        <i class="bi bi-house-heart-fill text-primary me-2"></i>
                        {% trans "理想的な市区町村を探そう！" %}
                    </h2>
                    <p class="text-muted">
                        {% trans "以下の項目であなたが重要視することをランキング形式で選択してください。" %}
                    </p>
                    <p class="text-muted">
                        {% trans "注：括弧内の言葉は、その項目で理想とされる状態" %}
                    </p>
                    <p class="text-muted">
                        {% trans "【価格・安全面・気温の変化・混雑度・選択した国の飲食店】"%}
                    </p>
                </div>
                <div id="alert-container"></div>
                <form method="post" id="survey-form" novalidate>
                    {% csrf_token %}
                    {% for rank in ranks %}
                        <div class="mb-3">
                           <label for="rank_{{ rank }}" class="form-label fw-semibold">
                                {{ rank }} 位:
                            </label>
                            <select class="form-select shadow-sm" id="rank_{{ rank }}" name="rank_{{ rank }}" required>
                                <option value="">--- {% trans "項目を選択" %} ---</option>
                                {% for criteria in criteria_list %}
                                    <option value="{{ criteria.id }}">
                                        {{ criteria.name }} (
                                        {% if criteria.is_reverse %}
                                            {{ criteria.right_label }}
                                        {% else %}
                                            {{ criteria.left_label }}
                                        {% endif %}
                                        )
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endfor %}
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm" id="submit-button">
                            <i class="bi bi-check-circle-fill me-2"></i> {% trans "完了" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('survey-form');
        const selects = document.querySelectorAll('select');
        const alertContainer = document.getElementById('alert-container');

        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Ngăn chặn form submit mặc định

            // Xóa tất cả cảnh báo cũ
            alertContainer.innerHTML = '';

            const selectedValues = new Set();
            let hasDuplicate = false;
            let hasEmpty = false;

            selects.forEach(s => {
                if (s.value) {
                    if (selectedValues.has(s.value)) {
                        hasDuplicate = true;
                    }
                    selectedValues.add(s.value);
                } else {
                    hasEmpty = true;
                }
            });

            if (hasEmpty) {
                showAlert('Please select a criteria for all ranks.', 'danger');
                return; // Dừng lại nếu có ô chưa chọn
            }

            if (hasDuplicate) {
                showAlert('Each criteria must be chosen only once.', 'danger');
                return; // Dừng lại nếu có tiêu chí bị trùng
            }

            // Nếu mọi thứ đều hợp lệ, submit form
            form.submit();
        });

        function showAlert(message, type) {
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        }
    });
</script>
{% endblock %}