{% extends 'base.html' %}
{% load widget_tweaks %}
{% load i18n %}
{% load static %}

{% block title %}Information{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css?family=Roboto:400,100,300,700" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    nav {
        position: relative;
        z-index: 2;
    }

    .bg-blur {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: url("{% static 'chamu/city.jpg' %}") no-repeat center center fixed;
        background-size: cover;
        filter: blur(2px);
        z-index: 0;
        opacity: 0.6;
    }

    .content-on-blur {
        position: relative;
        z-index: 1;
        padding-top: 50px;
        padding-bottom: 50px;
    }

    .row.justify-content-center {
        display: flex;
        align-items: center;
    }

    .contact-wrap {
        background: rgba(255,255,255,0.95);
        border-radius: 20px;
        box-shadow: 0 2px 16px 0 rgba(25, 118, 210, 0.08);
        padding: 2rem 3rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .contact-wrap form {
        display: flex;
        flex-direction: column;
    }

    .form-group {
        margin-bottom: 1rem; /* Khoảng cách giữa các form-group */
        flex-grow: 1;
        max-width: 100%;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #ddd;
        padding: 0.75rem;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
        width: 100%; /* Cố định chiều rộng */
        box-sizing: border-box; /* Tính cả padding và border vào kích thước */
    }

    /* Giảm khoảng cách cho nút "Start Survey" */
    .form-group.mt-4 {
        margin-top: 1rem !important; /* Thay thế mt-4 của Bootstrap */
    }

    .btn-primary {
        background-color: #1976d2;
        border-color: #1976d2;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: background-color 0.3s, transform 0.3s;
    }
    .btn-primary:hover {
        background-color: #1565c0;
        border-color: #1565c0;
        transform: translateY(-2px);
    }

    #map {
        height: 500px;
        border-radius: 20px;
        border: 2px solid #ddd;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .map-instruction {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: #1565c0;
        text-align: center;
    }
    #map-loading {
        text-align: center;
        margin-top: 1rem;
    }
    .loading .contact-wrap, .loading #map {
        pointer-events: none;
    }
</style>

<div class="bg-blur"></div>
<div class="content-on-blur">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="row">
                <div class="col-md-6">
                    <div class="contact-wrap w-100 p-md-5 p-4">
                        <h3 class="mb-4">{% trans "ユーザ情報" %}</h3>
                        <form method="post" id="match-info-form" autocomplete="off">
                            {% csrf_token %}
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger py-2">{{ form.non_field_errors }}</div>
                            {% endif %}
                            <div class="form-group">
                                <label for="id_name" class="label fw-semibold">名前</label>
                                {{ form.name|add_class:'form-control' }}
                                {% if form.name.errors %}
                                    <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="id_country" class="label fw-semibold">国</label>
                                {{ form.country|add_class:'form-select' }}
                                {% if form.country.errors %}
                                    <div class="text-danger small mt-1">{{ form.country.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="id_target_prefecture" class="label fw-semibold">希望の都道府県</label>
                                {{ form.target_prefecture|add_class:'form-select' }}
                                {% if form.target_prefecture.errors %}
                                    <div class="text-danger small mt-1">{{ form.target_prefecture.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group mt-4 mb-0 text-center">
                                <button type="submit" class="btn btn-primary w-100" id="submit-button">
                                    {% trans "開始" %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-md-6 d-flex align-items-center">
                    <div class="p-4 w-100">
                        <div class="map-instruction">
                            <i class="fa fa-info-circle"></i>
                            {% trans "地図をクリック、もしくは左の選択肢一覧から都道府県を選択してください。" %}
                        </div>
                        <div id="map"></div>
                        <div id="map-loading" class="text-center mt-2" style="display: none;">
                            <i class="fa fa-spinner fa-spin"></i> {% trans "読み込み中．．．" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const nameInput = document.getElementById('id_name');
        const countrySelect = document.getElementById('id_country');
        const prefectureSelect = document.getElementById('id_target_prefecture');
        const submitButton = document.getElementById('submit-button');
        const mapLoadingDiv = document.getElementById('map-loading');

        let isUpdatingFromMap = false;

        // Initialize map
        const map = L.map('map').setView([35.6895, 139.6917], 5); // Default to Tokyo
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let currentMarker = null;

        function updateMap(lat, lng, zoom = 10) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            if (lat && lng) {
                const latlng = [lat, lng];
                map.setView(latlng, zoom);
                currentMarker = L.marker(latlng).addTo(map);
            }
        }

        function showLoading(show) {
            if (show) {
                mapLoadingDiv.style.display = 'block';
                document.body.classList.add('loading');
            } else {
                mapLoadingDiv.style.display = 'none';
                document.body.classList.remove('loading');
            }
        }

        function checkFormValidity() {
            const isValid = nameInput.value.trim() &&
                           countrySelect.value &&
                           prefectureSelect.value;
            submitButton.disabled = !isValid;
        }

        // Prefecture change handler
        prefectureSelect.addEventListener('change', function() {
            const prefectureId = this.value;

            if (!isUpdatingFromMap && prefectureId) {
                showLoading(true);
                fetch(`/api/prefecture_coords/?prefecture_id=${prefectureId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.latitude && data.longitude) {
                            updateMap(data.latitude, data.longitude, 8);
                        }
                    })
                    .finally(() => {
                        showLoading(false);
                    });
            }
            checkFormValidity();
        });

        // Map click handler
        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            showLoading(true);
            isUpdatingFromMap = true;

            updateMap(lat, lng, map.getZoom());

            fetch(`/api/location_by_coords/?lat=${lat}&lng=${lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.prefecture_id) {
                        prefectureSelect.value = data.prefecture_id;
                        checkFormValidity();
                    } else {
                        alert('No prefecture found for this location.');
                    }
                })
                .catch(error => {
                    console.error('Error getting location:', error);
                    alert('Error getting location information. Please try a different area.');
                })
                .finally(() => {
                    isUpdatingFromMap = false;
                    showLoading(false);
                });
        });

        // Validation and event listeners
        nameInput.addEventListener('input', checkFormValidity);
        countrySelect.addEventListener('change', checkFormValidity);

        // Initial form check
        checkFormValidity();
    });
</script>
{% endblock extra_js %}