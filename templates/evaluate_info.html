{% extends 'base.html' %}
{% load i18n %}
{% load widget_tweaks %}
{% load static %}
{% block title %}Information{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css?family=Roboto:400,100,300,700" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
    nav {
        position: relative;
        z-index: 2; 
    }
    body, .content-on-blur, label, h3, h1, h2, p, .btn {
        font-family: 'Libertinus Serif' !important;
    }
    .bg-blur {
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: url("{% static 'chamu/city.jpg' %}") no-repeat center center fixed;
        background-size: cover;
        filter: blur(2px);
        z-index: 0;
        opacity: 0.6;
    }
    .content-on-blur {
        position: relative;
        z-index: 1;
    }
    .wrapper.img {
        background-image: url('{% static 'chamu/img.jpg' %}');
        background-size: cover;
        background-position: center;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        padding: 0;
    }
    .contact-wrap {
        background: rgba(255,255,255,0.95);
        border-radius: 20px;
        box-shadow: 0 2px 16px 0 rgba(25, 118, 210, 0.08);
    }
    .btn-primary {
        padding: 12px 40px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1.1rem;
        letter-spacing: 1px;
    }
</style>

<div class="bg-blur"></div>
<div class="content-on-blur">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="wrapper img" >
                <div class="row">
                    <div class="col-md-9 col-lg-7">
                        <div class="contact-wrap w-100 p-md-5 p-4">
                            <h3 class="mb-4 text-center" style="color:#000 !important; background:#fff !important;">Rating your neighborhood</h3>
                            <div id="form-message-warning" class="mb-4"></div>
                            <div id="form-message-success" class="mb-4" style="display:none;">
                                {% trans "Your message was sent, thank you!" %}
                            </div>
                            <form method="post" id="evaluate-info-form" autocomplete="off">
                                {% csrf_token %}
                                {% if form.non_field_errors %}
                                    <div class="alert alert-danger py-2">{{ form.non_field_errors }}</div>
                                {% endif %}
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group mb-3">
                                            <label class="label fw-semibold" for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                                            {{ form.name|add_class:'form-control' }}
                                            {% if form.name.errors %}
                                                <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group mb-3">
                                            <label class="label fw-semibold" for="{{ form.country.id_for_label }}" style="margin-left: 10px;">{{ form.country.label }}</label>
                                            {{ form.country|add_class:'form-select' }}
                                            {% if form.country.errors %}
                                                <div class="text-danger small mt-1">{{ form.country.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group mb-3">
                                            <label class="label fw-semibold" for="{{ form.current_prefecture.id_for_label }}" style ="margin-left: 120px;">{{ form.current_prefecture.label }}</label>
                                            {{ form.current_prefecture|add_class:'form-select' }}
                                            {% if form.current_prefecture.errors %}
                                                <div class="text-danger small mt-1">{{ form.current_prefecture.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group mb-3">
                                            <label class="label fw-semibold" for="{{ form.municipality.id_for_label }}" style="margin-left: 125px;">{{ form.municipality.label }}</label>
                                            {{ form.municipality|add_class:'form-select' }}
                                            {% if form.municipality.errors %}
                                                <div class="text-danger small mt-1">{{ form.municipality.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group mt-4 mb-0 text-center">
                                            <button type="submit" class="btn btn-primary">{% trans "Start Survey" %}</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Hãy đảm bảo rằng các ID trong JavaScript khớp với ID của form
        const nameInput = document.getElementById('id_name');
        const countrySelect = document.getElementById('id_country');
        const prefectureSelect = document.getElementById('id_current_prefecture');
        const municipalitySelect = document.getElementById('id_municipality');
        const submitButton = document.querySelector('button[type="submit"]');

        submitButton.disabled = true;

        function checkFormValidity() {
            if (nameInput.value && countrySelect.value && prefectureSelect.value && municipalitySelect.value) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        nameInput.addEventListener('input', checkFormValidity);
        countrySelect.addEventListener('change', checkFormValidity);
        prefectureSelect.addEventListener('change', function() {
            const prefectureId = this.value;

            municipalitySelect.innerHTML = '';
            municipalitySelect.disabled = true;
            checkFormValidity();

            if (prefectureId) {
                fetch(`/api/municipalities/?prefecture_id=${prefectureId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(muni => {
                            const option = document.createElement('option');
                            option.value = muni.id;
                            option.textContent = muni.name;
                            municipalitySelect.appendChild(option);
                        });
                        municipalitySelect.disabled = false;
                        checkFormValidity();
                    });
            }
        });

        municipalitySelect.addEventListener('change', checkFormValidity);
    });
</script>
{% endblock extra_js %}