{% load i18n %}
<!-- Modal Update -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="update-form" class="modal-content modal-auth-form">
      <div class="modal-header">
        <h5 class="modal-title" id="updateModalLabel">{% trans "Update Account" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <div id="update-hint" class="alert alert-info py-2 d-flex justify-content-between align-items-center-dismissible fade show" role="alert" style="font-size:0.93em;">
          <span>Submit is only allowed when all 3 fields are filled in.</span>
          <button type="button" id="hide-update-hint" class="btn btn-sm btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div id="update-error-list" class="alert alert-danger py-2" style="display:none"></div>
        <div class="mb-3">
          <label for="update-username" class="form-label">{% trans "Username" %}</label>
          <input type="text" class="form-control" id="update-username" name="username" required >
        </div>
        <div class="mb-3">
          <label for="update-password" class="form-label">{% trans "Password" %}</label>
          <input type="password" class="form-control" id="update-password" name="password" required>
          <div class="form-text text-muted">{% trans "Your password must have at least 6 characters" %}</div>
        </div>
        <div class="mb-3">
          <label for="update-password2" class="form-label">{% trans "Retype Password" %}</label>
          <input type="password" class="form-control" id="update-password2" name="password2" required>
        </div>
        <div class="mb-3">
          <label for="update-prefecture" class="form-label">Prefecture</label>
          <select class="form-control" id="update-prefecture" name="prefecture" required disabled>
            <option value="">Select prefecture</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="update-municipality" class="form-label">Municipality</label>
          <select class="form-control" id="update-municipality" name="municipality" required disabled>
            <option value="">Select municipality</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
        <button type="submit" class="btn btn-success" id="update-submit-btn">{% trans "Submit" %}</button>
      </div>
    </form>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

    $(function() {

        const $updatePrefecture = $('#update-prefecture');
        const $updateMunicipality = $('#update-municipality');

        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // Load prefectures vào select update-prefecture
        function loadUpdatePrefectures(selectedId, callback) {
            $.get('/api/prefectures/', function(data){
                $updatePrefecture.empty().append('<option value="">Select prefecture</option>');
                data.forEach(function(p){
                    $updatePrefecture.append('<option value="'+p.id+'">'+p.name+'</option>');
                });
                $updatePrefecture.prop('disabled', false);
                if (selectedId) $updatePrefecture.val(selectedId);
                if (callback) callback();
            });
        }

        function loadUpdateMunicipalities(prefectureId, selectedId) {
            $updateMunicipality.empty().append('<option value="">Select municipality</option>').prop('disabled', true);
            if (prefectureId) {
                $.get('/api/municipalities/', {prefecture_id: prefectureId}, function(data){
                    data.forEach(function(m){
                        $updateMunicipality.append('<option value="'+m.id+'">'+m.name+'</option>');
                    });
                    $updateMunicipality.prop('disabled', false);
                    if (selectedId) $updateMunicipality.val(selectedId);
                });
            }
        }

        // Hiện modal update khi nhấn nút Update
        $('#update-btn').on('click', function() {
            $('#update-error-list').hide().empty();
            $('#update-form')[0].reset();
            // Gán sẵn tên và để mật khẩu rỗng
            $('#update-username').val('{{ user.username|escapejs }}');
            $('#update-password').val('');
            $('#update-password2').val('');
            $('#update-submit-btn').prop('disabled', true);

            let pref_id = '{{ user.userinfo.prefecture.id|default_if_none:"" }}';
            let muni_id = '{{ user.userinfo.municipality.id|default_if_none:"" }}';

        // SỬA: Load prefectures, rồi load municipalities nếu có prefecture đã chọn
        loadUpdatePrefectures(pref_id, function() {
            if (pref_id) {
                loadUpdateMunicipalities(pref_id, muni_id);
            } else {
                $updateMunicipality.empty().append('<option value="">Select municipality</option>').prop('disabled', true);
            }
        });

        $('#update-hint').remove();
        $('.modal-body', '#update-form').prepend(`
            <div id="update-hint" class="alert alert-info py-2 d-flex justify-content-between align-items-center-dismissible fade show" role="alert" style="font-size:0.93em;">
              <span>Submit is only allowed when all fields are filled in.</span>
              <button type="button" id="hide-update-hint" class="btn btn-sm btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
        $('#updateModal').modal('show');

        // Khi chọn prefecture thì lọc lại municipality
        $updatePrefecture.off('change').on('change', function() {
            let pref_id = $(this).val();
            loadUpdateMunicipalities(pref_id);
        });
    });

        $(document).on('click', '#hide-update-hint', function() {
            $('#update-hint').remove();
        });

        // Enable submit khi đủ trường
        function checkUpdateFields() {
            let u = $('#update-username').val().trim();
            let p = $('#update-password').val();
            let p2 = $('#update-password2').val();
            let pref = $updatePrefecture.val();
            let muni = $updateMunicipality.val();
            if(u && p && p2 && pref && muni) {
               $('#update-submit-btn').prop('disabled', false);
            } else {
                $('#update-submit-btn').prop('disabled', true);
            }
        }
        $('#update-username, #update-password, #update-password2, #update-prefecture, #update-municipality').on('input change', checkUpdateFields);

        // Submit update AJAX
        $('#update-form').on('submit', function(e) {
            e.preventDefault();
            const username = $('#update-username').val().trim();
            const password = $('#update-password').val();
            const password2 = $('#update-password2').val();
            const prefecture = $('#update-prefecture').val();
            const municipality = $('#update-municipality').val();

            let errorList = [];
            if(!username || !password || !password2 || !prefecture || !municipality) {
                errorList.push("Please fill in all fields.");
            }
            if(errorList.length) {
                let html = '<ul class="mb-0">';
                errorList.forEach(function(err) {
                    html += '<li>' + err + '</li>';
                });
                html += '</ul>';
                $('#update-error-list').html(html).show();
                return;
            }

            $.ajax({
                url: '{% url "ajax_update" %}',
                method: 'POST',
                data: {
                    username: username,
                    password: password,
                    password2: password2,
                    prefecture: prefecture,
                    municipality: municipality
                },
                success: function(data) {
                    if (data.success) {
                        $('#updateModal').modal('hide');
                        location.reload();
                    } else if (data.errors) {
                        let html = '<ul class="mb-0">';
                        data.errors.forEach(function(err) {
                            html += '<li>' + err + '</li>';
                        });
                        html += '</ul>';
                        $('#update-error-list').html(html).show();
                    }
                }
            });
        });
});
</script>