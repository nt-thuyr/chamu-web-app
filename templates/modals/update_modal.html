{% load i18n %}
<!-- Modal Update -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="update-form" class="modal-content modal-auth-form">
      <div class="modal-header">
        <h5 class="modal-title" id="updateModalLabel">{% trans "Update Account" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <div id="update-hint" class="alert alert-info py-2 d-flex justify-content-between align-items-center-dismissible fade show" role="alert" style="font-size:0.93em;">
          <span>Submit is only allowed when all 3 fields are filled in.</span>
          <button type="button" id="hide-update-hint" class="btn btn-sm btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div id="update-error-list" class="alert alert-danger py-2" style="display:none"></div>
        <div class="mb-3">
          <label for="update-username" class="form-label">{% trans "Username" %}</label>
          <input type="text" class="form-control" id="update-username" name="username" required >
        </div>
        <div class="mb-3">
          <label for="update-password" class="form-label">{% trans "Password" %}</label>
          <input type="password" class="form-control" id="update-password" name="password" required>
          <div class="form-text text-muted">{% trans "Your password must have at least 6 characters" %}</div>
        </div>
        <div class="mb-3">
          <label for="update-password2" class="form-label">{% trans "Retype Password" %}</label>
          <input type="password" class="form-control" id="update-password2" name="password2" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
        <button type="submit" class="btn btn-success" id="update-submit-btn">{% trans "Submit" %}</button>
      </div>
    </form>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(function() {
        // Hiện modal update khi nhấn nút Update
        $('#update-btn').on('click', function() {
            $('#update-error-list').hide().empty();
            $('#update-form')[0].reset();
            // Gán sẵn tên và để mật khẩu rỗng
            $('#update-username').val('{{ user.username|escapejs }}');
            $('#update-password').val('');
            $('#update-password2').val('');
            $('#update-submit-btn').prop('disabled', true);

            // Gắn lại chú thích vào đầu modal-body
            $('#update-hint').remove();
            $('.modal-body', '#update-form').prepend(updateHintHtml);
            $('#updateModal').modal('show');
        });

        // Đăng ký lại sự kiện tắt chú thích
        $(document).on('click', '#hide-update-hint', function() {
            $('#update-hint').remove();
        });

        // Kiểm tra đủ 3 trường mới enable submit cho update
        function checkUpdateFields() {
            let u = $('#update-username').val().trim();
            let p = $('#update-password').val();
            let p2 = $('#update-password2').val();
            if(u && p && p2) {
               $('#update-submit-btn').prop('disabled', false);
            } else {
                $('#update-submit-btn').prop('disabled', true);
            }
        }
        $('#update-username, #update-password, #update-password2').on('input', checkUpdateFields);

        // Submit update AJAX
        $('#update-form').on('submit', function(e) {
        e.preventDefault();
        const username = $('#update-username').val().trim();
        const password = $('#update-password').val();
        const password2 = $('#update-password2').val();

        let errorList = [];
        if(!username || !password || !password2) {
            errorList.push("Please fill in all fields.");
        }
        if(errorList.length) {
            let html = '<ul class="mb-0">';
            errorList.forEach(function(err) {
                html += '<li>' + err + '</li>';
            });
            html += '</ul>';
            $('#update-error-list').html(html).show();
            return;
        }

        // Gửi lên server để nhận về list lỗi đầy đủ
        $.ajax({
            url: '{% url "ajax_update" %}',
            method: 'POST',
            data: {
                username: username,
                password: password,
                password2: password2
            },
            success: function(data) {
                if (data.success) {
                    $('#updateModal').modal('hide');
                } else if (data.errors) {
                    let html = '<ul class="mb-0">';
                    data.errors.forEach(function(err) {
                        html += '<li>' + err + '</li>';
                    });
                    html += '</ul>';
                    $('#update-error-list').html(html).show();
                }
            }
        });
    });

});
</script>