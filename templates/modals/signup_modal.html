{% load i18n %}
<!-- Modal Sign up -->
<div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="signup-form" class="modal-content modal-auth-form">
      <div class="modal-header">
        <h5 class="modal-title" id="signupModalLabel">{% trans "Sign up" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <div id="signup-error-list" class="alert alert-danger py-2" style="display:none"></div>
        <div class="mb-3">
          <label for="signup-username" class="form-label">{% trans "Username" %}</label>
          <input type="text" class="form-control" id="signup-username" name="username" required>
        </div>
        <div class="mb-3">
          <label for="signup-password" class="form-label">{% trans "Password" %}</label>
          <input type="password" class="form-control" id="signup-password" name="password" required>
          <div class="form-text text-muted">{% trans "Your password must have at least 6 characters" %}</div>
        </div>
        <div class="mb-3">
          <label for="signup-password2" class="form-label">{% trans "Retype Password" %}</label>
          <input type="password" class="form-control" id="signup-password2" name="password2" required>
        </div>
        <div class="mb-3">
          <label for="signup-country" class="form-label">Country</label>
          <select class="form-control" id="signup-country" name="country" required>
            <option value="">Select country</option>
            {% for c in country_choices %}
              <option value="{{ c.0 }}">{{ c.1 }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="signup-prefecture" class="form-label">Prefecture</label>
          <select class="form-control" id="signup-prefecture" name="prefecture" required>
          </select>
        </div>
        <div class="mb-3">
          <label for="signup-municipality" class="form-label">Municipality</label>
          <select class="form-control" id="signup-municipality" name="municipality" required disabled>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">{% trans "Register" %}</button>
      </div>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function loadPrefectures() {

    $.get('/api/prefectures/', function(data){
        const $pref = $('#signup-prefecture');
        $pref.empty().append('<option value="">Select prefecture</option>');
        data.forEach(function(p){
            $pref.append('<option value="'+p.id+'">'+p.name+'</option>');
        });
        $pref.prop('disabled', false);
        });
    }
$(function() {

        // Lần đầu load prefectures
        loadPrefectures();

        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // Luôn load toàn bộ prefecture khi mở modal, enable luôn
        loadPrefectures();

        // Khi chọn Prefecture thì load Municipality phù hợp
        $('#signup-prefecture').on('change', function() {
            const prefectureId = $(this).val();
            const $muni = $('#signup-municipality');
            $muni.empty().append('<option value="">Select municipality</option>').prop('disabled', true);
            if (prefectureId) {
                $.get('/api/municipalities/', {prefecture_id: prefectureId}, function(data){
                    data.forEach(function(m){
                        $muni.append('<option value="'+m.id+'">'+m.name+'</option>');
                    });
                    $muni.prop('disabled', false);
                });
            }
        });

        // Khi mở modal signup thì clear municipality, clear prefecture (giữ country)
        $('#signup-btn').on('click', function() {
            $('#signup-prefecture').val('').prop('disabled', true).empty().append('<option value="">Select prefecture</option>');
            $('#signup-municipality').val('').prop('disabled', true).empty().append('<option value="">Select municipality</option>');
            loadPrefectures();
        });

        // Submit signup AJAX
        $('#signup-form').on('submit', function(e) {
            e.preventDefault();
            const country = $('#signup-country').val();
            const prefecture = $('#signup-prefecture').val();
            const municipality = $('#signup-municipality').val();
            if (!country || !prefecture || !municipality) {
                $('#signup-error-list').html('<ul class="mb-0"><li>Bạn phải chọn đủ Country, Prefecture và Municipality.</li></ul>').show();
                return;
            }
            $.ajax({
                url: '{% url "ajax_signup" %}',
                method: 'POST',
                data: {
                    username: $('#signup-username').val(),
                    password: $('#signup-password').val(),
                    password2: $('#signup-password2').val(),
                    country: country,
                    prefecture: prefecture,
                    municipality: municipality
                },
                success: function(data) {
                    if (data.success) {
                        const modalEl = document.getElementById('signupModal');
                        let modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (!modalInstance) {
                            modalInstance = new bootstrap.Modal(modalEl);
                        }
                        modalInstance.hide();
                        location.reload();
                    } else {
                        if (data.errors) {
                            let html = '<ul class="mb-0">';
                            data.errors.forEach(function(err) {
                                html += '<li>' + err + '</li>';
                            });
                            html += '</ul>';
                            $('#signup-error-list').html(html).show();
                        } else if (data.error) {
                            $('#signup-error-list').html('<ul class="mb-0"><li>' + data.error + '</li></ul>').show();
                        }
                    }
                }
            });
        });

});
</script>