{% load i18n %}
<!-- Modal Sign up -->
<div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="signup-form" class="modal-content modal-auth-form">
      <div class="modal-header">
        <h5 class="modal-title" id="signupModalLabel">{% trans "Sign up" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <div id="signup-error-list" class="alert alert-danger py-2" style="display:none"></div>
        <div class="mb-3">
          <label for="signup-username" class="form-label">{% trans "Username" %}</label>
          <input type="text" class="form-control" id="signup-username" name="username" required>
        </div>
        <div class="mb-3">
          <label for="signup-password" class="form-label">{% trans "Password" %}</label>
          <input type="password" class="form-control" id="signup-password" name="password" required>
          <div class="form-text text-muted">{% trans "Your password must have at least 6 characters" %}</div>
        </div>
        <div class="mb-3">
          <label for="signup-password2" class="form-label">{% trans "Retype Password" %}</label>
          <input type="password" class="form-control" id="signup-password2" name="password2" required>
        </div>
        <div class="mb-3">
          <label for="signup-country" class="form-label">Country</label>
          <select class="form-control" id="signup-country" name="country" required>
            <option value="">Select country</option>
            {% for c in country_choices %}
              <option value="{{ c.0 }}">{{ c.1 }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="signup-prefecture" class="form-label">Prefecture</label>
          <select class="form-control" id="signup-prefecture" name="prefecture" required>
          </select>
        </div>
        <div class="mb-3">
          <label for="signup-municipality" class="form-label">Municipality</label>
          <select class="form-control" id="signup-municipality" name="municipality" required disabled>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">{% trans "Register" %}</button>
      </div>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
$(function() {
        // Khởi tạo Tom Select single-select cho từng trường
        const countryTomSelect = new TomSelect('#signup-country', {
            placeholder: 'Select country',
            allowEmptyOption: false,
            create: false,
            maxOptions: 1000,
        });
        const prefectureTomSelect = new TomSelect('#signup-prefecture', {
            placeholder: 'Select prefecture',
            allowEmptyOption: false,
            create: false,
            maxOptions: 1000,
        });
        const municipalityTomSelect = new TomSelect('#signup-municipality', {
            placeholder: 'Select municipality',
            allowEmptyOption: false,
            create: false,
            maxOptions: 1000,
        });
         // Luôn load toàn bộ prefecture khi mở modal, enable luôn
        $.get('/api/prefectures/', function(data){
            prefectureTomSelect.clearOptions();
            data.forEach(function(p){
                prefectureTomSelect.addOption({value: p.id, text: p.name});
            });
            prefectureTomSelect.enable();
        });
        countryTomSelect.enable(); // country luôn mở

        // Khi chọn Prefecture thì load Municipality phù hợp
        prefectureTomSelect.on('change', function() {
            const prefectureId = this.getValue();
            municipalityTomSelect.clearOptions();
            municipalityTomSelect.disable();
            if (prefectureId) {
                $.get('/api/municipalities/', {prefecture_id: prefectureId}, function(data){
                    data.forEach(function(m){
                        municipalityTomSelect.addOption({value: m.id, text: m.name});
                    });
                    municipalityTomSelect.enable();
                });
            }
        });

        // Khi mở modal signup thì clear municipality, clear prefecture (giữ country)
        $('#signup-btn').on('click', function() {
            municipalityTomSelect.clearOptions();
            municipalityTomSelect.disable();
            prefectureTomSelect.clear();
        });

        // Submit signup AJAX
        $('#signup-form').on('submit', function(e) {
            e.preventDefault();
            const country = countryTomSelect.getValue();
            const prefecture = prefectureTomSelect.getValue();
            const municipality = municipalityTomSelect.getValue();
            if (!country || !prefecture || !municipality) {
                $('#signup-error-list').html('<ul class="mb-0"><li>Bạn phải chọn đủ Country, Prefecture và Municipality.</li></ul>').show();
                return;
            }
            $.ajax({
                url: '{% url "ajax_signup" %}',
                method: 'POST',
                data: {
                    username: $('#signup-username').val(),
                    password: $('#signup-password').val(),
                    password2: $('#signup-password2').val(),
                    country: country,
                    prefecture: prefecture,
                    municipality: municipality
                },
                success: function(data) {
                    if (data.success) {
                        $('#signupModal').modal('hide');
                        location.reload();
                    } else {
                        if (data.errors) {
                            let html = '<ul class="mb-0">';
                            data.errors.forEach(function(err) {
                                html += '<li>' + err + '</li>';
                            });
                            html += '</ul>';
                            $('#signup-error-list').html(html).show();
                        } else if (data.error) {
                            $('#signup-error-list').html('<ul class="mb-0"><li>' + data.error + '</li></ul>').show();
                        }
                    }
                }
            });
        });

});
</script>